
## STEP 4- showing the top 15 genes

```{r}
# find significant DEGs
sum( res$padj < 0.1, na.rm=TRUE )

# clean and delete na
res_df <- as.data.frame(res)
res_df <- res_df[!is.na(res_df$padj), ]

#order by significance
res_ordered <- res_df[order(res_df$padj), ]

# extract top15
top15 <- head(res_ordered, 15)
top15
top15_table <- top15[, c("log2FoldChange", "pvalue", "padj")]
top15_table


```

## STEP 5- plotting for visualization

```{r}

# 1-Data quality control plots

# PCA plot

vsd <- vst(dds, blind=FALSE)
plotPCA(vsd, intgroup = c("Group", "replaceable"), ntop = 500)
plotPCA(vsd, intgroup = "Group", ntop = 500)




# simple distance heatmap- overall gene-expression profiles.
# compute sample-to-sample distances
dists <- dist(t(assay(vsd)))

# convert to matrix
mat <- as.matrix(dists)

pheatmap(mat,
         clustering_distance_rows = dists,
         clustering_distance_cols = dists,
         show_rownames = TRUE,
         show_colnames = TRUE,
         fontsize_row = 4,
         fontsize_col = 4,
         angle_col = 45,
         main = "Sample-to-sample Distance Heatmap")




```

```{r}
# 2- DE analysis

# MA plot
plotMA(res)

# volcano plot

# Get the rownames of top15 genes
top15_genes <- rownames(top15_table)

EnhancedVolcano(
  res,
  lab = rownames(res),
  x = 'log2FoldChange',
  y = 'padj',
  pCutoff = 0.05,
  FCcutoff = 0.5,
  selectLab = top15_genes,     # highlights and labels ONLY your top 15
  pointSize = 1.5,
  labSize = 4,
  col = c('grey30', 'forestgreen', 'royalblue', 'red2'),
  title = "Volcano Plot (Top 15 Most Significant Genes)",
  subtitle = "Top genes labelled based on lowest adjusted p-values"
)

```


```{r}
# 3- Biological interpretation plots

library(RColorBrewer)

# Heatmap for Top 15 DEGs

# Extract expression matrix from VST
vsd_mat <- assay(vsd)

# Get the rownames of top15 genes
top15_genes <- rownames(top15_table)

# Intersect to avoid missing genes (just in case)
top15_genes <- intersect(top15_genes, rownames(vsd_mat))

# Subset the VST matrix
heatmap_top15 <- vsd_mat[top15_genes, ]

# Plot heatmap
pheatmap(
  heatmap_top15,
  scale = "row",
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  show_rownames = TRUE,
  show_colnames = TRUE,
  fontsize_row = 6,
  fontsize_col = 6,
  angle_col = 45,
  color = colorRampPalette(c("navy", "white", "firebrick3"))(100),
  main = "Top 15 Differentially Expressed Genes"
)


# boxplot
library(reshape2)

# choose how many genes you want (here: top 6)
top_genes <- rownames(top15_table)[1:6]


# subset top genes
expr_top <- vsd_mat[top_genes, ]

# convert to long format for ggplot
df <- melt(expr_top)
colnames(df) <- c("Gene", "Sample", "Expression")

# add group info to each sample
df$Group <- colData(vsd)$Group[match(df$Sample, rownames(colData(vsd)))]

ggplot(df, aes(x = Group, y = Expression, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 1.3, alpha = 0.7) +
  facet_wrap(~ Gene, scales = "free_y", ncol = 3) +
  theme_bw(base_size = 12) +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "none"
  ) +
  ylab("VST Normalized Expression") +
  ggtitle("Expression Boxplots of Top Differentially Expressed Genes")
